pipeline: acme_edw_modelled
flowgroup: partsupp_modelled_fct

presets:
  - default_delta_properties


actions:
  - name: partsupp_modelled_fct_load
    type: load
    readMode: batch
    source:
      type: sql
      sql: |
          select
          p.part_key,
          s.supplier_key,
          ps.* except(end_week_key,start_week_key)
          from
            (
              select
                *,
                cast(replace(`__START_AT`, '-W', '') as int) as `start_week_key`,
                coalesce(cast(replace(`__END_AT`, '-W', '') as int),99999999) as `end_week_key`
              from
                {catalog}.{silver_schema}.partsupp_dim
            ) ps
              join (
                select
                  *,
                  cast(replace(`__START_AT`, '-W', '') as int) as `start_week_key`,
                coalesce(cast(replace(`__END_AT`, '-W', '') as int),99999999) as `end_week_key`
                from
                  {catalog}.{silver_schema}.supplier_dim
              ) s
                on ps.supplier_id = s.supplier_id
                and ps.start_week_key between s.start_week_key and s.end_week_key
              join (
                select
                  *,
                  CAST(
                    EXTRACT(YEAROFWEEK FROM `__START_AT`) * 100 + EXTRACT(WEEK FROM `__START_AT`) AS INTEGER
                  ) AS start_week_key,
                  coalesce(CAST(
                    EXTRACT(YEAROFWEEK FROM `__END_AT`) * 100 + EXTRACT(WEEK FROM `__END_AT`) AS INTEGER
                  ),99999999) AS end_week_key
                from
                  {catalog}.{silver_schema}.part_dim
              ) p
              on ps.part_id = p.part_id
    target: v_partsupp_modelled_fct
    description: "Load partsupp table with surrogate keys" 


  - name: partsupp_modelled_fct_write
    type: write
    source: v_partsupp_modelled_fct
    write_target:
      type: materialized_view
      database: "{catalog}.{gold_schema}"
      table: "partsupp_modelled_fct"
      